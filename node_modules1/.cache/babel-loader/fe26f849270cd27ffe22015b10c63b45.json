{"ast":null,"code":"var childproc = require('child_process'),\n    EventEmitter = require('events').EventEmitter;\n\nfunction exec2(file, args\n/*, options, callback */\n) {\n  var options = {\n    encoding: 'utf8',\n    timeout: 0,\n    maxBuffer: 500 * 1024,\n    killSignal: 'SIGKILL',\n    output: null\n  };\n  var callback = arguments[arguments.length - 1];\n  if ('function' != typeof callback) callback = null;\n\n  if (typeof arguments[2] == 'object') {\n    var keys = Object.keys(options);\n\n    for (var i = 0; i < keys.length; i++) {\n      var k = keys[i];\n      if (arguments[2][k] !== undefined) options[k] = arguments[2][k];\n    }\n  }\n\n  var child = childproc.spawn(file, args);\n  var killed = false;\n  var timedOut = false;\n\n  var Wrapper = function (proc) {\n    this.proc = proc;\n    this.stderr = new Accumulator();\n    proc.emitter = new EventEmitter();\n    proc.on = proc.emitter.on.bind(proc.emitter);\n    this.out = proc.emitter.emit.bind(proc.emitter, 'data');\n    this.err = this.stderr.out.bind(this.stderr);\n    this.errCurrent = this.stderr.current.bind(this.stderr);\n  };\n\n  Wrapper.prototype.finish = function (err) {\n    this.proc.emitter.emit('end', err, this.errCurrent());\n  };\n\n  var Accumulator = function (cb) {\n    this.stdout = {\n      contents: \"\"\n    };\n    this.stderr = {\n      contents: \"\"\n    };\n    this.callback = cb;\n\n    var limitedWrite = function (stream) {\n      return function (chunk) {\n        stream.contents += chunk;\n\n        if (!killed && stream.contents.length > options.maxBuffer) {\n          child.kill(options.killSignal);\n          killed = true;\n        }\n      };\n    };\n\n    this.out = limitedWrite(this.stdout);\n    this.err = limitedWrite(this.stderr);\n  };\n\n  Accumulator.prototype.current = function () {\n    return this.stdout.contents;\n  };\n\n  Accumulator.prototype.errCurrent = function () {\n    return this.stderr.contents;\n  };\n\n  Accumulator.prototype.finish = function (err) {\n    this.callback(err, this.stdout.contents, this.stderr.contents);\n  };\n\n  var std = callback ? new Accumulator(callback) : new Wrapper(child);\n  var timeoutId;\n\n  if (options.timeout > 0) {\n    timeoutId = setTimeout(function () {\n      if (!killed) {\n        child.kill(options.killSignal);\n        timedOut = true;\n        killed = true;\n        timeoutId = null;\n      }\n    }, options.timeout);\n  }\n\n  child.stdout.setEncoding(options.encoding);\n  child.stderr.setEncoding(options.encoding);\n  child.stdout.addListener(\"data\", function (chunk) {\n    std.out(chunk, options.encoding);\n  });\n  child.stderr.addListener(\"data\", function (chunk) {\n    std.err(chunk, options.encoding);\n  });\n  var version = process.versions.node.split('.');\n  child.addListener(version[0] == 0 && version[1] < 7 ? \"exit\" : \"close\", function (code, signal) {\n    if (timeoutId) clearTimeout(timeoutId);\n\n    if (code === 0 && signal === null) {\n      std.finish(null);\n    } else {\n      var e = new Error(\"Command \" + (timedOut ? \"timed out\" : \"failed\") + \": \" + std.errCurrent());\n      e.timedOut = timedOut;\n      e.killed = killed;\n      e.code = code;\n      e.signal = signal;\n      std.finish(e);\n    }\n  });\n  return child;\n}\n\n;\n\nfunction parseIdentify(input) {\n  var lines = input.split(\"\\n\"),\n      prop = {},\n      props = [prop],\n      prevIndent = 0,\n      indents = [indent],\n      currentLine,\n      comps,\n      indent,\n      i;\n  lines.shift(); //drop first line (Image: name.jpg)\n\n  for (i in lines) {\n    currentLine = lines[i];\n    indent = currentLine.search(/\\S/);\n\n    if (indent >= 0) {\n      comps = currentLine.split(': ');\n      if (indent > prevIndent) indents.push(indent);\n\n      while (indent < prevIndent && props.length) {\n        indents.pop();\n        prop = props.pop();\n        prevIndent = indents[indents.length - 1];\n      }\n\n      if (comps.length < 2) {\n        props.push(prop);\n        prop = prop[currentLine.split(':')[0].trim().toLowerCase()] = {};\n      } else {\n        prop[comps[0].trim().toLowerCase()] = comps[1].trim();\n      }\n\n      prevIndent = indent;\n    }\n  }\n\n  return prop;\n}\n\n;\n\nexports.identify = function (pathOrArgs, callback) {\n  var isCustom = Array.isArray(pathOrArgs),\n      isData,\n      args = isCustom ? [].concat(pathOrArgs) : ['-verbose', pathOrArgs];\n\n  if (typeof args[args.length - 1] === 'object') {\n    isData = true;\n    pathOrArgs = args[args.length - 1];\n    args[args.length - 1] = '-';\n    if (!pathOrArgs.data) throw new Error('first argument is missing the \"data\" member');\n  } else if (typeof pathOrArgs === 'function') {\n    args[args.length - 1] = '-';\n    callback = pathOrArgs;\n  }\n\n  var proc = exec2(exports.identify.path, args, {\n    timeout: 120000\n  }, function (err, stdout, stderr) {\n    var result, geometry;\n\n    if (!err) {\n      if (isCustom) {\n        result = stdout;\n      } else {\n        result = parseIdentify(stdout);\n        geometry = result['geometry'].split(/x/);\n        result.format = result.format.match(/\\S*/)[0];\n        result.width = parseInt(geometry[0]);\n        result.height = parseInt(geometry[1]);\n        result.depth = parseInt(result.depth);\n        if (result.quality !== undefined) result.quality = parseInt(result.quality) / 100;\n      }\n    }\n\n    callback(err, result);\n  });\n\n  if (isData) {\n    if ('string' === typeof pathOrArgs.data) {\n      proc.stdin.setEncoding('binary');\n      proc.stdin.write(pathOrArgs.data, 'binary');\n      proc.stdin.end();\n    } else {\n      proc.stdin.end(pathOrArgs.data);\n    }\n  }\n\n  return proc;\n};\n\nexports.identify.path = 'identify';\n\nfunction ExifDate(value) {\n  // YYYY:MM:DD HH:MM:SS -> Date(YYYY-MM-DD HH:MM:SS +0000)\n  value = value.split(/ /);\n  return new Date(value[0].replace(/:/g, '-') + ' ' + value[1] + ' +0000');\n}\n\nfunction exifKeyName(k) {\n  return k.replace(exifKeyName.RE, function (x) {\n    if (x.length === 1) return x.toLowerCase();else return x.substr(0, x.length - 1).toLowerCase() + x.substr(x.length - 1);\n  });\n}\n\nexifKeyName.RE = /^[A-Z]+/;\nvar exifFieldConverters = {\n  // Numbers\n  bitsPerSample: Number,\n  compression: Number,\n  exifImageLength: Number,\n  exifImageWidth: Number,\n  exifOffset: Number,\n  exposureProgram: Number,\n  flash: Number,\n  imageLength: Number,\n  imageWidth: Number,\n  isoSpeedRatings: Number,\n  jpegInterchangeFormat: Number,\n  jpegInterchangeFormatLength: Number,\n  lightSource: Number,\n  meteringMode: Number,\n  orientation: Number,\n  photometricInterpretation: Number,\n  planarConfiguration: Number,\n  resolutionUnit: Number,\n  rowsPerStrip: Number,\n  samplesPerPixel: Number,\n  sensingMethod: Number,\n  stripByteCounts: Number,\n  subSecTime: Number,\n  subSecTimeDigitized: Number,\n  subSecTimeOriginal: Number,\n  customRendered: Number,\n  exposureMode: Number,\n  focalLengthIn35mmFilm: Number,\n  gainControl: Number,\n  saturation: Number,\n  sharpness: Number,\n  subjectDistanceRange: Number,\n  subSecTime: Number,\n  subSecTimeDigitized: Number,\n  subSecTimeOriginal: Number,\n  whiteBalance: Number,\n  sceneCaptureType: Number,\n  // Dates\n  dateTime: ExifDate,\n  dateTimeDigitized: ExifDate,\n  dateTimeOriginal: ExifDate\n};\n\nexports.readMetadata = function (path, callback) {\n  return exports.identify(['-format', '%[EXIF:*]', path], function (err, stdout) {\n    var meta = {};\n\n    if (!err) {\n      stdout.split(/\\n/).forEach(function (line) {\n        var eq_p = line.indexOf('=');\n        if (eq_p === -1) return;\n        var key = line.substr(0, eq_p).replace('/', '-'),\n            value = line.substr(eq_p + 1).trim(),\n            typekey = 'default';\n        var p = key.indexOf(':');\n\n        if (p !== -1) {\n          typekey = key.substr(0, p);\n          key = key.substr(p + 1);\n\n          if (typekey === 'exif') {\n            key = exifKeyName(key);\n            var converter = exifFieldConverters[key];\n            if (converter) value = converter(value);\n          }\n        }\n\n        if (!(typekey in meta)) meta[typekey] = {\n          key: value\n        };else meta[typekey][key] = value;\n      });\n    }\n\n    callback(err, meta);\n  });\n};\n\nexports.convert = function (args, timeout, callback) {\n  var procopt = {\n    encoding: 'binary'\n  };\n\n  if (typeof timeout === 'function') {\n    callback = timeout;\n    timeout = 0;\n  } else if (typeof timeout !== 'number') {\n    timeout = 0;\n  }\n\n  if (timeout && (timeout = parseInt(timeout)) > 0 && !isNaN(timeout)) procopt.timeout = timeout;\n  return exec2(exports.convert.path, args, procopt, callback);\n};\n\nexports.convert.path = 'convert';\n\nvar resizeCall = function (t, callback) {\n  var proc = exports.convert(t.args, t.opt.timeout, callback);\n\n  if (t.opt.srcPath.match(/-$/)) {\n    if ('string' === typeof t.opt.srcData) {\n      proc.stdin.setEncoding('binary');\n      proc.stdin.write(t.opt.srcData, 'binary');\n      proc.stdin.end();\n    } else {\n      proc.stdin.end(t.opt.srcData);\n    }\n  }\n\n  return proc;\n};\n\nexports.resize = function (options, callback) {\n  var t = exports.resizeArgs(options);\n  return resizeCall(t, callback);\n};\n\nexports.crop = function (options, callback) {\n  if (typeof options !== 'object') throw new TypeError('First argument must be an object');\n  if (!options.srcPath && !options.srcData) throw new TypeError(\"No srcPath or data defined\");\n  if (!options.height && !options.width) throw new TypeError(\"No width or height defined\");\n\n  if (options.srcPath) {\n    var args = options.srcPath;\n  } else {\n    var args = {\n      data: options.srcData\n    };\n  }\n\n  exports.identify(args, function (err, meta) {\n    if (err) return callback && callback(err);\n    var t = exports.resizeArgs(options),\n        ignoreArg = false,\n        printNext = false,\n        args = [];\n    t.args.forEach(function (arg) {\n      if (printNext === true) {\n        console.log(\"arg\", arg);\n        printNext = false;\n      } // ignoreArg is set when resize flag was found\n\n\n      if (!ignoreArg && arg != '-resize') args.push(arg); // found resize flag! ignore the next argument\n\n      if (arg == '-resize') {\n        console.log(\"resize arg\");\n        ignoreArg = true;\n        printNext = true;\n      }\n\n      if (arg === \"-crop\") {\n        console.log(\"crop arg\");\n        printNext = true;\n      } // found the argument after the resize flag; ignore it and set crop options\n\n\n      if (arg != \"-resize\" && ignoreArg) {\n        var dSrc = meta.width / meta.height,\n            dDst = t.opt.width / t.opt.height,\n            resizeTo = dSrc < dDst ? '' + t.opt.width + 'x' : 'x' + t.opt.height,\n            dGravity = options.gravity ? options.gravity : \"Center\";\n        args = args.concat(['-resize', resizeTo, '-gravity', dGravity, '-crop', '' + t.opt.width + 'x' + t.opt.height + '+0+0', '+repage']);\n        ignoreArg = false;\n      }\n    });\n    t.args = args;\n    resizeCall(t, callback);\n  });\n};\n\nexports.resizeArgs = function (options) {\n  var opt = {\n    srcPath: null,\n    srcData: null,\n    srcFormat: null,\n    dstPath: null,\n    quality: 0.8,\n    format: 'jpg',\n    progressive: false,\n    colorspace: null,\n    width: 0,\n    height: 0,\n    strip: true,\n    filter: 'Lagrange',\n    sharpening: 0.2,\n    customArgs: [],\n    timeout: 0\n  }; // check options\n\n  if (typeof options !== 'object') throw new Error('first argument must be an object');\n\n  for (var k in opt) if (k in options) opt[k] = options[k];\n\n  if (!opt.srcPath && !opt.srcData) throw new Error('both srcPath and srcData are empty'); // normalize options\n\n  if (!opt.format) opt.format = 'jpg';\n\n  if (!opt.srcPath) {\n    opt.srcPath = opt.srcFormat ? opt.srcFormat + ':-' : '-'; // stdin\n  }\n\n  if (!opt.dstPath) opt.dstPath = opt.format ? opt.format + ':-' : '-'; // stdout\n\n  if (opt.width === 0 && opt.height === 0) throw new Error('both width and height can not be 0 (zero)'); // build args\n\n  var args = [opt.srcPath];\n\n  if (opt.sharpening > 0) {\n    args = args.concat(['-set', 'option:filter:blur', String(1.0 - opt.sharpening)]);\n  }\n\n  if (opt.filter) {\n    args.push('-filter');\n    args.push(opt.filter);\n  }\n\n  if (opt.strip) {\n    args.push('-strip');\n  }\n\n  if (opt.width || opt.height) {\n    args.push('-resize');\n    if (opt.height === 0) args.push(String(opt.width));else if (opt.width === 0) args.push('x' + String(opt.height));else args.push(String(opt.width) + 'x' + String(opt.height));\n  }\n\n  opt.format = opt.format.toLowerCase();\n  var isJPEG = opt.format === 'jpg' || opt.format === 'jpeg';\n\n  if (isJPEG && opt.progressive) {\n    args.push('-interlace');\n    args.push('plane');\n  }\n\n  if (isJPEG || opt.format === 'png') {\n    args.push('-quality');\n    args.push(Math.round(opt.quality * 100.0).toString());\n  } else if (opt.format === 'miff' || opt.format === 'mif') {\n    args.push('-quality');\n    args.push(Math.round(opt.quality * 9.0).toString());\n  }\n\n  if (opt.colorspace) {\n    args.push('-colorspace');\n    args.push(opt.colorspace);\n  }\n\n  if (Array.isArray(opt.customArgs) && opt.customArgs.length) args = args.concat(opt.customArgs);\n  args.push(opt.dstPath);\n  return {\n    opt: opt,\n    args: args\n  };\n};","map":{"version":3,"sources":["/home/a/Documents/GitHub/react-ts-project/node_modules/imagemagick/imagemagick.js"],"names":["childproc","require","EventEmitter","exec2","file","args","options","encoding","timeout","maxBuffer","killSignal","output","callback","arguments","length","keys","Object","i","k","undefined","child","spawn","killed","timedOut","Wrapper","proc","stderr","Accumulator","emitter","on","bind","out","emit","err","errCurrent","current","prototype","finish","cb","stdout","contents","limitedWrite","stream","chunk","kill","std","timeoutId","setTimeout","setEncoding","addListener","version","process","versions","node","split","code","signal","clearTimeout","e","Error","parseIdentify","input","lines","prop","props","prevIndent","indents","indent","currentLine","comps","shift","search","push","pop","trim","toLowerCase","exports","identify","pathOrArgs","isCustom","Array","isArray","isData","concat","data","path","result","geometry","format","match","width","parseInt","height","depth","quality","stdin","write","end","ExifDate","value","Date","replace","exifKeyName","RE","x","substr","exifFieldConverters","bitsPerSample","Number","compression","exifImageLength","exifImageWidth","exifOffset","exposureProgram","flash","imageLength","imageWidth","isoSpeedRatings","jpegInterchangeFormat","jpegInterchangeFormatLength","lightSource","meteringMode","orientation","photometricInterpretation","planarConfiguration","resolutionUnit","rowsPerStrip","samplesPerPixel","sensingMethod","stripByteCounts","subSecTime","subSecTimeDigitized","subSecTimeOriginal","customRendered","exposureMode","focalLengthIn35mmFilm","gainControl","saturation","sharpness","subjectDistanceRange","whiteBalance","sceneCaptureType","dateTime","dateTimeDigitized","dateTimeOriginal","readMetadata","meta","forEach","line","eq_p","indexOf","key","typekey","p","converter","convert","procopt","isNaN","resizeCall","t","opt","srcPath","srcData","resize","resizeArgs","crop","TypeError","ignoreArg","printNext","arg","console","log","dSrc","dDst","resizeTo","dGravity","gravity","srcFormat","dstPath","progressive","colorspace","strip","filter","sharpening","customArgs","String","isJPEG","Math","round","toString"],"mappings":"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","sourcesContent":["var childproc = require('child_process'),\n    EventEmitter = require('events').EventEmitter;\n\n\nfunction exec2(file, args /*, options, callback */) {\n  var options = { encoding: 'utf8'\n                , timeout: 0\n                , maxBuffer: 500*1024\n                , killSignal: 'SIGKILL'\n                , output: null\n                };\n\n  var callback = arguments[arguments.length-1];\n  if ('function' != typeof callback) callback = null;\n\n  if (typeof arguments[2] == 'object') {\n    var keys = Object.keys(options);\n    for (var i = 0; i < keys.length; i++) {\n      var k = keys[i];\n      if (arguments[2][k] !== undefined) options[k] = arguments[2][k];\n    }\n  }\n\n  var child = childproc.spawn(file, args);\n  var killed = false;\n  var timedOut = false;\n\n  var Wrapper = function(proc) {\n    this.proc = proc;\n    this.stderr = new Accumulator();\n    proc.emitter = new EventEmitter();\n    proc.on = proc.emitter.on.bind(proc.emitter);\n    this.out = proc.emitter.emit.bind(proc.emitter, 'data');\n    this.err = this.stderr.out.bind(this.stderr);\n    this.errCurrent = this.stderr.current.bind(this.stderr);\n  };\n  Wrapper.prototype.finish = function(err) {\n    this.proc.emitter.emit('end', err, this.errCurrent());\n  };\n\n  var Accumulator = function(cb) {\n    this.stdout = {contents: \"\"};\n    this.stderr = {contents: \"\"};\n    this.callback = cb;\n\n    var limitedWrite = function(stream) {\n      return function(chunk) {\n        stream.contents += chunk;\n        if (!killed && stream.contents.length > options.maxBuffer) {\n          child.kill(options.killSignal);\n          killed = true;\n        }\n      };\n    };\n    this.out = limitedWrite(this.stdout);\n    this.err = limitedWrite(this.stderr);\n  };\n  Accumulator.prototype.current = function() { return this.stdout.contents; };\n  Accumulator.prototype.errCurrent = function() { return this.stderr.contents; };\n  Accumulator.prototype.finish = function(err) { this.callback(err, this.stdout.contents, this.stderr.contents); };\n\n  var std = callback ? new Accumulator(callback) : new Wrapper(child);\n\n  var timeoutId;\n  if (options.timeout > 0) {\n    timeoutId = setTimeout(function () {\n      if (!killed) {\n        child.kill(options.killSignal);\n        timedOut = true;\n        killed = true;\n        timeoutId = null;\n      }\n    }, options.timeout);\n  }\n\n  child.stdout.setEncoding(options.encoding);\n  child.stderr.setEncoding(options.encoding);\n\n  child.stdout.addListener(\"data\", function (chunk) { std.out(chunk, options.encoding); });\n  child.stderr.addListener(\"data\", function (chunk) { std.err(chunk, options.encoding); });\n\n  var version = process.versions.node.split('.');\n  child.addListener(version[0] == 0 && version[1] < 7 ? \"exit\" : \"close\", function (code, signal) {\n    if (timeoutId) clearTimeout(timeoutId);\n    if (code === 0 && signal === null) {\n      std.finish(null);\n    } else {\n      var e = new Error(\"Command \"+(timedOut ? \"timed out\" : \"failed\")+\": \" + std.errCurrent());\n      e.timedOut = timedOut;\n      e.killed = killed;\n      e.code = code;\n      e.signal = signal;\n      std.finish(e);\n    }\n  });\n\n  return child;\n};\n\n\nfunction parseIdentify(input) {\n  var lines = input.split(\"\\n\"),\n      prop = {},\n      props = [prop],\n      prevIndent = 0,\n      indents = [indent],\n      currentLine, comps, indent, i;\n\n  lines.shift(); //drop first line (Image: name.jpg)\n\n  for (i in lines) {\n    currentLine = lines[i];\n    indent = currentLine.search(/\\S/);\n    if (indent >= 0) {\n      comps = currentLine.split(': ');\n      if (indent > prevIndent) indents.push(indent);\n      while (indent < prevIndent && props.length) {\n        indents.pop();\n        prop = props.pop();\n        prevIndent = indents[indents.length - 1];\n      }\n      if (comps.length < 2) {\n        props.push(prop);\n        prop = prop[currentLine.split(':')[0].trim().toLowerCase()] = {};\n      } else {\n        prop[comps[0].trim().toLowerCase()] = comps[1].trim()\n      }\n      prevIndent = indent;\n    }\n  }\n  return prop;\n};\n\nexports.identify = function(pathOrArgs, callback) {\n  var isCustom = Array.isArray(pathOrArgs),\n      isData,\n      args = isCustom ? ([]).concat(pathOrArgs) : ['-verbose', pathOrArgs];\n\n  if (typeof args[args.length-1] === 'object') {\n    isData = true;\n    pathOrArgs = args[args.length-1];\n    args[args.length-1] = '-';\n    if (!pathOrArgs.data)\n      throw new Error('first argument is missing the \"data\" member');\n  } else if (typeof pathOrArgs === 'function') {\n    args[args.length-1] = '-';\n    callback = pathOrArgs;\n  }\n  var proc = exec2(exports.identify.path, args, {timeout:120000}, function(err, stdout, stderr) {\n    var result, geometry;\n    if (!err) {\n      if (isCustom) {\n        result = stdout;\n      } else {\n        result = parseIdentify(stdout);\n        geometry = result['geometry'].split(/x/);\n\n        result.format = result.format.match(/\\S*/)[0]\n        result.width = parseInt(geometry[0]);\n        result.height = parseInt(geometry[1]);\n        result.depth = parseInt(result.depth);\n        if (result.quality !== undefined) result.quality = parseInt(result.quality) / 100;\n      }\n    }\n    callback(err, result);\n  });\n  if (isData) {\n    if ('string' === typeof pathOrArgs.data) {\n      proc.stdin.setEncoding('binary');\n      proc.stdin.write(pathOrArgs.data, 'binary');\n      proc.stdin.end();\n    } else {\n      proc.stdin.end(pathOrArgs.data);\n    }\n  }\n  return proc;\n}\nexports.identify.path = 'identify';\n\nfunction ExifDate(value) {\n  // YYYY:MM:DD HH:MM:SS -> Date(YYYY-MM-DD HH:MM:SS +0000)\n  value = value.split(/ /);\n  return new Date(value[0].replace(/:/g, '-')+' '+\n    value[1]+' +0000');\n}\n\nfunction exifKeyName(k) {\n  return k.replace(exifKeyName.RE, function(x){\n    if (x.length === 1) return x.toLowerCase();\n    else return x.substr(0,x.length-1).toLowerCase()+x.substr(x.length-1);\n  });\n}\nexifKeyName.RE = /^[A-Z]+/;\n\nvar exifFieldConverters = {\n  // Numbers\n  bitsPerSample:Number, compression:Number, exifImageLength:Number,\n  exifImageWidth:Number, exifOffset:Number, exposureProgram:Number,\n  flash:Number, imageLength:Number, imageWidth:Number, isoSpeedRatings:Number,\n  jpegInterchangeFormat:Number, jpegInterchangeFormatLength:Number,\n  lightSource:Number, meteringMode:Number, orientation:Number,\n  photometricInterpretation:Number, planarConfiguration:Number,\n  resolutionUnit:Number, rowsPerStrip:Number, samplesPerPixel:Number,\n  sensingMethod:Number, stripByteCounts:Number, subSecTime:Number,\n  subSecTimeDigitized:Number, subSecTimeOriginal:Number, customRendered:Number,\n  exposureMode:Number, focalLengthIn35mmFilm:Number, gainControl:Number,\n  saturation:Number, sharpness:Number, subjectDistanceRange:Number,\n  subSecTime:Number, subSecTimeDigitized:Number, subSecTimeOriginal:Number,\n  whiteBalance:Number, sceneCaptureType:Number,\n\n  // Dates\n  dateTime:ExifDate, dateTimeDigitized:ExifDate, dateTimeOriginal:ExifDate\n};\n\nexports.readMetadata = function(path, callback) {\n  return exports.identify(['-format', '%[EXIF:*]', path], function(err, stdout) {\n    var meta = {};\n    if (!err) {\n      stdout.split(/\\n/).forEach(function(line){\n        var eq_p = line.indexOf('=');\n        if (eq_p === -1) return;\n        var key = line.substr(0, eq_p).replace('/','-'),\n            value = line.substr(eq_p+1).trim(),\n            typekey = 'default';\n        var p = key.indexOf(':');\n        if (p !== -1) {\n          typekey = key.substr(0, p);\n          key = key.substr(p+1);\n          if (typekey === 'exif') {\n            key = exifKeyName(key);\n            var converter = exifFieldConverters[key];\n            if (converter) value = converter(value);\n          }\n        }\n        if (!(typekey in meta)) meta[typekey] = {key:value};\n        else meta[typekey][key] = value;\n      })\n    }\n    callback(err, meta);\n  });\n}\n\nexports.convert = function(args, timeout, callback) {\n  var procopt = {encoding: 'binary'};\n  if (typeof timeout === 'function') {\n    callback = timeout;\n    timeout = 0;\n  } else if (typeof timeout !== 'number') {\n    timeout = 0;\n  }\n  if (timeout && (timeout = parseInt(timeout)) > 0 && !isNaN(timeout))\n    procopt.timeout = timeout;\n  return exec2(exports.convert.path, args, procopt, callback);\n}\nexports.convert.path = 'convert';\n\nvar resizeCall = function(t, callback) {\n  var proc = exports.convert(t.args, t.opt.timeout, callback);\n  if (t.opt.srcPath.match(/-$/)) {\n    if ('string' === typeof t.opt.srcData) {\n      proc.stdin.setEncoding('binary');\n      proc.stdin.write(t.opt.srcData, 'binary');\n      proc.stdin.end();\n    } else {\n      proc.stdin.end(t.opt.srcData);\n    }\n  }\n  return proc;\n}\n\nexports.resize = function(options, callback) {\n  var t = exports.resizeArgs(options);\n  return resizeCall(t, callback)\n}\n\nexports.crop = function (options, callback) {\n  if (typeof options !== 'object')\n    throw new TypeError('First argument must be an object');\n  if (!options.srcPath && !options.srcData)\n    throw new TypeError(\"No srcPath or data defined\");\n  if (!options.height && !options.width)\n    throw new TypeError(\"No width or height defined\");\n  \n  if (options.srcPath){\n    var args = options.srcPath;\n  } else {\n    var args = {\n      data: options.srcData\n    };\n  }\n\n  exports.identify(args, function(err, meta) {\n    if (err) return callback && callback(err);\n    var t         = exports.resizeArgs(options),\n        ignoreArg = false,\n        printNext  = false,\n        args      = [];\n    t.args.forEach(function (arg) {\n      if (printNext === true){\n        console.log(\"arg\", arg);\n        printNext = false;\n      }\n      // ignoreArg is set when resize flag was found\n      if (!ignoreArg && (arg != '-resize'))\n        args.push(arg);\n      // found resize flag! ignore the next argument\n      if (arg == '-resize'){\n        console.log(\"resize arg\");\n        ignoreArg = true;\n        printNext = true;\n      }\n      if (arg === \"-crop\"){\n        console.log(\"crop arg\");\n        printNext = true;\n      }\n      // found the argument after the resize flag; ignore it and set crop options\n      if ((arg != \"-resize\") && ignoreArg) {\n        var dSrc      = meta.width / meta.height,\n            dDst      = t.opt.width / t.opt.height,\n            resizeTo  = (dSrc < dDst) ? ''+t.opt.width+'x' : 'x'+t.opt.height,\n            dGravity  = options.gravity ? options.gravity : \"Center\";\n        args = args.concat([\n          '-resize', resizeTo,\n          '-gravity', dGravity,\n          '-crop', ''+t.opt.width + 'x' + t.opt.height + '+0+0',\n          '+repage'\n        ]);\n        ignoreArg = false;\n      }\n    })\n\n    t.args = args;\n    resizeCall(t, callback);\n  })\n}\n\nexports.resizeArgs = function(options) {\n  var opt = {\n    srcPath: null,\n    srcData: null,\n    srcFormat: null,\n    dstPath: null,\n    quality: 0.8,\n    format: 'jpg',\n    progressive: false,\n    colorspace: null,\n    width: 0,\n    height: 0,\n    strip: true,\n    filter: 'Lagrange',\n    sharpening: 0.2,\n    customArgs: [],\n    timeout: 0\n  }\n\n  // check options\n  if (typeof options !== 'object')\n    throw new Error('first argument must be an object');\n  for (var k in opt) if (k in options) opt[k] = options[k];\n  if (!opt.srcPath && !opt.srcData)\n    throw new Error('both srcPath and srcData are empty');\n\n  // normalize options\n  if (!opt.format) opt.format = 'jpg';\n  if (!opt.srcPath) {\n    opt.srcPath = (opt.srcFormat ? opt.srcFormat +':-' : '-'); // stdin\n  }\n  if (!opt.dstPath)\n    opt.dstPath = (opt.format ? opt.format+':-' : '-'); // stdout\n  if (opt.width === 0 && opt.height === 0)\n    throw new Error('both width and height can not be 0 (zero)');\n\n  // build args\n  var args = [opt.srcPath];\n  if (opt.sharpening > 0) {\n    args = args.concat([\n      '-set', 'option:filter:blur', String(1.0-opt.sharpening)]);\n  }\n  if (opt.filter) {\n    args.push('-filter');\n    args.push(opt.filter);\n  }\n  if (opt.strip) {\n    args.push('-strip');\n  }\n  if (opt.width || opt.height) {\n    args.push('-resize');\n    if (opt.height === 0) args.push(String(opt.width));\n    else if (opt.width === 0) args.push('x'+String(opt.height));\n    else args.push(String(opt.width)+'x'+String(opt.height));\n  }\n  opt.format = opt.format.toLowerCase();\n  var isJPEG = (opt.format === 'jpg' || opt.format === 'jpeg');\n  if (isJPEG && opt.progressive) {\n    args.push('-interlace');\n    args.push('plane');\n  }\n  if (isJPEG || opt.format === 'png') {\n    args.push('-quality');\n    args.push(Math.round(opt.quality * 100.0).toString());\n  }\n  else if (opt.format === 'miff' || opt.format === 'mif') {\n    args.push('-quality');\n    args.push(Math.round(opt.quality * 9.0).toString());\n  }\n  if (opt.colorspace) {\n    args.push('-colorspace');\n    args.push(opt.colorspace);\n  }\n  if (Array.isArray(opt.customArgs) && opt.customArgs.length)\n    args = args.concat(opt.customArgs);\n  args.push(opt.dstPath);\n\n  return {opt:opt, args:args};\n}\n"]},"metadata":{},"sourceType":"script"}